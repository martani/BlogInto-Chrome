<head>
<meta http-equiv="Content-Type" content="text/html; charset=Windows-1256" /> 

<script type="text/javascript" src="jquery/js/jquery-1.4.2.min.js"></script>

<script>
	// Language files
	
	function getLanguageResources(){
		var fr = new Array(); var en = new Array(); var ar = new Array();
		fr['settings'] = "paramètres"; en['settings'] = "settings"; ar['settings'] = "ÅÚÏÇÏÇÊ";
		fr['default_feed'] = "Flux par défaut"; en['default_feed'] = "Default feed"; ar['default_feed'] = "ÇáãæÞÚ ÇáãÝÖá";
		fr['algeria_user_pass'] = "(Algérie) Utilisateur & Mot de passe"; en['algeria_user_pass'] = "(Algeria) Username & Password"; ar['algeria_user_pass'] = "(ÇáÌÒÇÆÑ) ÇÓã ÇáãÓÊÎÏã æ ßáãÉ ÇáãÑæÑ";
		fr['morocco_user_pass'] = "(Marroc) Utilisateur & Mot de passe"; en['morocco_user_pass'] = "(Morocco) Username & Password"; ar['morocco_user_pass'] = "(ÇáãÛÑÈ) ÇÓã ÇáãÓÊÎÏã æ ßáãÉ ÇáãÑæÑ";
		
		fr['request_timeout'] = "Temps de réponse de la requête :"; en['request_timeout'] = "Request timeout :"; ar['request_timeout'] = "ãÏÉ ÇáÇÓÊÌÇÈÉ :";
		fr['fetch_posts_each'] = "Récupère les messages chaque :"; en['fetch_posts_each'] = "Fetch posts each :";  ar['fetch_posts_each'] = "ÊÍÏíË ÇáÑÓÇÆá ßá :";
		fr['read_feeds_are_to_be'] = "Afficher / Masquer les messages lus :"; en['read_feeds_are_to_be'] = "Read feeds are to be :"; ar['read_feeds_are_to_be'] = "ÅÙåÇÑ/ÅÎÝÇÁ ÇáÑÓÇÆá ÇáãÞÑæÁÉ :";
		fr['just_marked'] = " Afficher"; en['just_marked'] = "Just marked"; ar['just_marked'] = "ÅÙåÇÑ";
		fr['hidden'] = "Masquer"; en['hidden'] = " Hidden"; ar['hidden'] = "ÅÎÝÇÁ";
		
		fr['seconds'] = " secondes"; en['seconds'] = "seconds"; ar['seconds'] = "ËÇäíÉ";
		fr['minutes'] = "minutes"; en['minutes'] = "minutes"; ar['minutes'] = "ÏÞÇÆÞ";
		
		fr['save_settings'] = "Enregistrer les paramètres"; en['save_settings'] = "Save settings"; ar['save_settings'] = "ÍÝÙ ÇáÅÚÏÇÏÇÊ";
		fr['close_this'] = "Fermer"; en['close_this'] = "Close this"; ar['close_this'] = "ÅÛáÇÞ";
		
		fr['user'] = "Nom "; en['user'] = "User "; ar['user'] = "ÇÓã ÇáãÓÊÎÏã";
		fr['pass'] = "Mot de passe "; en['pass'] = "Password"; ar['pass'] = "ßáãÉ ÇáãÑæÑ";
		
		fr['verify'] = "Vérifier"; en['verify'] = "verify"; ar['verify'] = "ÊÌÑÈÉ";
		fr['loggin_successeful'] = "Connecté ;)"; en['loggin_successeful'] = "Logged in ;)"; ar['loggin_successeful'] = "ãÊÕá ;)";
		fr['failed_to_login'] = "Echec :("; en['failed_to_login'] = "Failed to login"; ar['failed_to_login'] = "ÝÔá ãÍÇæáÉ ÇáÇÊÕÇá";
		
		fr['algeria'] = "Algérie"; en['algeria'] = "Algeria"; ar['algeria'] = "ÇáÌÒÇÆÑ";
		fr['morocco'] = "Maroc"; en['morocco'] = "Morroco"; ar['morocco'] = "ÇáãÛÑÈ";
		
		fr['options_saved'] = "Parametres sauvegardées"; en['options_saved'] = "Options saved"; ar['options_saved'] = "Êã ÍÝÙ ÇáÎíÇÑÇÊ";
		fr['enjoy'] = " enjoy ;)"; en['enjoy'] = " enjoy ;)"; ar['enjoy'] = "  enjoy ;)";
		
		fr['error'] = "Erreur "; en['error'] = "Error "; ar['error'] = "ÎØÃ";
		fr['cannot_save_settings'] = " Paramatres non enregistrées, veillez esseyer à nouveau"; en['cannot_save_settings'] = " cannot save settings, please try again."; ar['cannot_save_settings'] = " ÃËäÇÁ ÍÝÙ ÇáÅÚÏÇÏÇÊ íÑÌì ÇáãÍÇæáÉ ãÌÏÏÇ ";
		
		fr['while_loading_the_feed'] = " lors du chargement du flux, Veuillez vérifier votre connection réseau"; en['while_loading_the_feed'] = " while loading the feed, Make sure you are connected to Internet."; ar['while_loading_the_feed'] = "ÃËäÇÁ ÊÍãíá ÇáÈíÇäÇÊ¡ íÑÌì ÇáÊÃßÏ ãä  Çä ÇáÌåÇÒ ãÊÕá ÈÇáÔÈßÉ";
		fr['slow_network'] = "Si vous avez une lente connexion, essayez de modifier le délai d'attente dans la page des paramètres."; en['slow_network'] = " If you have a slow network speed, try changing the timeout in the settings page."; ar['slow_network'] = "ÅÐÇ ßÇä ÇÊÕÇáßã ÈÇáÔÈßÉ ÈØíÆ¡ ÍÇæá ÊÛííÑ ãÏÉ ÇáÇÓÊÌÇÈÉ Ýí ÕÝÍÉ ÇáÅÚÏÇÏÇÊ";
		fr['failed_to_vote'] = "Erreur lors du sondage "; en['failed_to_vote'] = "Failed to vote "; ar['failed_to_vote'] = "ÎØÃ ÃËäÇÁ ÇáÊÕæíÊ ";
		fr['verify_correct_password'] = " veuillez vérifier que vous avez saisi le bon mot de passe dans la page des paramètres"; en['verify_correct_password'] = "Please verify that you have provided the correct password in the options page."; ar['verify_correct_password'] = " íÑÌì ÇáÊÃßÏ ãä ÕÍÉ ßáãÉ ÇáãÑæÑ Ýí ÕÝÍÉ ÇáÅÚÏÇÏÇÊ";
		fr['login_from_the_website'] = "Ou naviguez directement à Bloginy et connectez vous sur le site."; en['login_from_the_website'] = "Or navigate diretly to Bloginy and login from the website."; ar['login_from_the_website'] = " Ãæ íãßäßã ÊÓÌíá ÇáÏÎæá ãÈÇÔÑÉ ÚÈÑ ãæÞÚ Bloginy";
		
		fr['ok'] = "Fermer"; en['ok'] = "Close"; ar['ok'] = "ÅÛáÇÞ";
		fr['btn_parameters_dialog'] = "Paramètres"; en['btn_parameters_dialog'] = "Settings"; ar['btn_parameters_dialog'] = "ÅÚÏÇÏÇÊ";
		fr['btn_go_to_bloginy'] = "Connecter sur Bloginy"; en['btn_go_to_bloginy'] = "Connect on Bloginy"; ar['btn_go_to_bloginy'] = "ÊÓÌíá ÇáÏÎæá Úáì Bloginy";
		
		fr['tt_show-hide'] = "Afficher / Masquer les messages lus"; en['tt_show-hide'] = "Show / Hide read posts"; ar['tt_show-hide'] = "ÅÎÝÇÁ - ÅÙåÇÑ ÇáÑÓÇÆá ÇáãÞÑæÁÉ";
		fr['tt_refresh'] = "Actualiser"; en['tt_refresh'] = "Refresh"; ar['tt_refresh'] = "ÊÍÏíË";
		fr['tt_options'] = "Paramètres"; en['tt_options'] = "Settings"; ar['tt_options'] = "ÅÚÏÇÏÇÊ";
		
		var resources = new Array();
		resources['fr'] = fr;
		resources['en'] = en;
		resources['ar'] = ar;
		
		return resources;
	}
	
	function getDzUrl(){
		return "http://bloginy.com/api/topFeeds/7RaLaXvDsZhBcYhS/bloginto";
	}
	
	function getMaUrl(){
		return "http://bloginy.ma/api/topFeeds/oWxPfPyUkAb5q3aL/bloginto";
	}
	
	function IsNumeric(input)
	{
	   return (input - 0) == input && input.length > 0;
	}
		
	function isPostRead(title, feed){
		var read_posts = new Array();

		if(localStorage.getItem('read_posts_' + feed) != null)
			read_posts = JSON.parse(localStorage.getItem('read_posts_' + feed));
		else
			read_posts = null;

		var i;
			
		if(read_posts != null)
			for(i=0; i<read_posts.length; i++)
			{
				if(title == read_posts[i])
					return true;
			}
		
		return false;
	}
		
	function deleteOldPostsFromLocalStorage(arr_titles, feed){
		var new_arr = new Array();
				
		for(var i=0; i<arr_titles.length; i++){
			var title = arr_titles[i];
			if(isPostRead(title, feed))
				new_arr.push(title);
		}
				
		localStorage.setItem('read_posts_' + feed, JSON.stringify(new_arr));
	}

	function showUnreadPostsCount(xml, category){
		var unread_count = 0;
		var titles = new Array();
		
		try{
				var feeds = xml.getElementsByTagName("feed");
				for (var i = 0, feed; feed = feeds[i]; i++) {
					var title = feed.getElementsByTagName("title")[0].childNodes[0].nodeValue;
					
					var title_txt = $('<a>' + title + '</a>').text().substring(0, 50);
					
					titles.push(title_txt);
				}
				
				deleteOldPostsFromLocalStorage(titles, category);
				
				for(var i=0; i<titles.length; i++)
					if(!isPostRead(titles[i], category))
						unread_count++;
					
				localStorage["unread_count_" + category] = unread_count;
				chrome.browserAction.setBadgeText({text: unread_count.toString()});
		}
		catch(error){
			console.log('error foreach every feed');
			chrome.browserAction.setBadgeText({text: '?'});
		}
	}
	
	function updateBadgeText(){
		console.log('updating unread posts count');
		var defaultFeed = (localStorage["default_feed"] != "ma")? "dz" : "ma";
		var timeout_ = IsNumeric(localStorage["timeout"]) ? localStorage["timeout"] : 10;
		
		$.ajax({
				  url: (defaultFeed == 'dz') ? getDzUrl() : getMaUrl(),
				  cache: false,
				  timeout: (timeout_ * 1000),
				  dataType: (defaultFeed == "dz" ? "xml" : "html"),
				  success: function(html){
						if(defaultFeed == "dz")
							showUnreadPostsCount(html, defaultFeed); 
						else
						{
							try{
                                    if ((html.indexOf("bloginy_api") < 0) || (html.indexOf("<erreur>") > 0))
                                            throw("Problem loading the feeds");
                                    xmlParser = new DOMParser();
                                    xmlDocum = xmlParser.parseFromString(html, 'text/xml');
                                    showUnreadPostsCount(xmlDocum, defaultFeed); 
                                }
                            catch(err)
                                {
									console.log('error parsing the feed');
                                    chrome.browserAction.setBadgeText({text: '?'});
                                }
						}
				  },
				  error: function(xhr, msg, exn){
					console.log('error at the ajax call');
						chrome.browserAction.setBadgeText({text: '?'});
				  }
				});	
	}
	
	function checkIfIntervalTimeoutChanged(){
		console.log('chacking for interval change...');
		if(IsNumeric(localStorage["unread_timeout"]) && localStorage["unread_timeout"] != interval){
			console.log('interval changed, refreshing...')
			clearInterval(intervalID);
			interval = localStorage["unread_timeout"];
			intervalID = setInterval(updateBadgeText, interval * 60 * 1000);
		}
	}
	
	var intervalID;
	var interval = IsNumeric(localStorage["unread_timeout"]) ? localStorage["unread_timeout"] : 2;
	
	updateBadgeText();
	
	if(localStorage['first_load'] != 'true')
	{
		chrome.tabs.create({url : "options.html"});
		localStorage['first_load'] = 'true';
	}
	
	intervalID = setInterval(updateBadgeText, interval * 60 * 1000);
	
	//every 15 seconds check if the interval for fetching the unread count as changed or not and update the intervalID
	setInterval(checkIfIntervalTimeoutChanged, 15 * 1000);
</script>
</head>