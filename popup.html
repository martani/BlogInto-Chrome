<html>
<head>
<link type="text/css" href="themes/base/ui.all.css" rel="stylesheet" />
<link type="text/css" href="js-css/style.css" rel="stylesheet" />

<script type="text/javascript" src="js-css/jquery-1.4.1.min.js"></script>
<script type="text/javascript" src="js-css/jquery-ui.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
  		var selectedTab = (localStorage["default_feed"] != "ma")? "dz" : "ma";
  		var ma_url = "http://www.bloginy.ma/api/topFeeds/oWxPfPyUkAb5q3aL/bloginto";
  		var dz_url = "http://www.bloginy.com/api/topFeeds/7RaLaXvDsZhBcYhS/bloginto";
  		
		// returns the selected tab "dz" for "Bloginy Algérie", "ma" for "Bloginy Maroc"
	    function getSelectedTab(s){
	   		var i = (s.toString()).lastIndexOf("#");
			var selected_tab = (s.toString()).substr(i + 1);
			
			// refreh the global variable selectedTab used to refreh the current tab.
			selectedTab = selected_tab;
			return selected_tab; 
	    }
	    
		// refresh the current selected feed
	    function refresh(){
	    	if (selectedTab == "dz")
	   				  ajaxIt(dz_url, "dz", false);
				else
				   	  ajaxIt(ma_url, "ma", false);
	    }
	    
		// function called when the page loads to show the default feed 
		// [default_feed] : parameter chosen by the user in the settings page
		function loadDefaultFeed(){
			var defaultFeed = (localStorage["default_feed"] != "ma")? "dz" : "ma";
			
			if (defaultFeed == "dz")
				   	  ajaxIt(dz_url, "dz", true);
				else
				   	  ajaxIt(ma_url, "ma", true);
		}
		
		function getDefaultFeedIndex(){
			var defaultFeed = (localStorage["default_feed"] != "ma")? "dz" : "ma";
			if (defaultFeed == "dz")
				return 0;
			else
				return 1;
		}

		// Handles errors during the XMLHttpRequest.
		function handleError() {
			$("#error").show();
			$("#error").html("<h3 class='error'>Error loading the feed. </h3>");
		}
		
		// returns the HTML of a single feed element
		function getFeedHTML(title, description, author, date, url){
			return "<h3 class=\"h3-style\"><a href=\""+url+"\" class=\"url-title-style\" target=_blank>"+title.substring(0, 50)+"</a></h3>" +
				"<p class=\"description-style\" style=\"line-height: normal\">"+description.substring(0, 155)+"...</p>" +
				"<br/>" +
				"<span class=\"author-style\" style=\"float: left\"><strong>By : "+author+"</strong></span>" +	
				"<span class=\"date-style\" style=\"float: right\"><strong>"+date+"</strong></span>";
		}  
				
		// principle function, enumerating feed element and building the UI		
		function showFeeds(xml, cat) {
			var content = document.getElementById(cat);
			content.innerHTML = "";
			
			var url_root = (cat == "dz")? "http://www.bloginy.com" : "http://www.bloginy.ma";
			
			try{
				var feeds = xml.getElementsByTagName("feed");
				
				for (var i = 0, feed; feed = feeds[i]; i++) {
					var author = feed.getElementsByTagName("author")[0].childNodes[0].nodeValue;
					var date = feed.getElementsByTagName("pubdate")[0].childNodes[0].nodeValue;
					var title = feed.getElementsByTagName("title")[0].childNodes[0].nodeValue;
					var description = feed.getElementsByTagName("description")[0].childNodes[0].nodeValue;
					var url = url_root + feed.getElementsByTagName("link")[0].childNodes[0].nodeValue;
					
					var container = document.createElement("div");
					container.innerHTML = getFeedHTML(title, description, author, date, url);
					container.setAttribute("class", "borders");
	
					content.appendChild(container);
				}
			}catch(error){
				handleError();
			}
		}
		
		// function that handles the XHR requests
		function ajaxIt(url_, category, cached)
		{
				$.ajax({
				  url: url_,
				  cache: cached,
				  password: localStorage["pwd"],
				  username: localStorage["user"],
				  timeout: (10 * 1000),
				  success: function(html){
				  	$("#error").hide();
					  try{
					  		if ((html.indexOf("//Bloginy//Bloginy") < 0) || (html.indexOf("<erreur>") > 0))
					  			throw("Problem loading the feeds");
							xmlParser = new DOMParser();
							xmlDocum = xmlParser.parseFromString( html, 'text/xml');
			  		 	    showFeeds(xmlDocum, category); 
			  		  }
			  		  catch(err)
					  {
							handleError();
					  }
				  },
				  error: function(xhr, msg, exn){
						handleError();
				  }
				});	
		}
		
	    $('#loadingDiv')
	    .hide()  // hide it initially
	    .ajaxStart(function() {
	        $(this).show();
	    })
	    .ajaxStop(function() {
	        $(this).hide();
	    });
    	
    	$('#refresh').click(function(){
    		$('#' + selectedTab).animate({
									"height": "toggle", "opacity": "toggle"
										}, { duration: "slow" });
    		refresh();
    		$('#' + selectedTab).animate({
									"height": "toggle", "opacity": "toggle"
										}, { duration: "slow" });

    	});
    	
		$('#options').click(function(){
			chrome.tabs.create({url : "options.html"});
		});
		
        var $tabs = $("#tabs").tabs({selected : getDefaultFeedIndex(), fx: { opacity: 'toggle' },
    
		    select: function(event, ui) {
				var selected = $tabs.tabs('option', 'selected');
				var id = getSelectedTab(ui.tab);
				if (id != "dz")
				   	  ajaxIt(ma_url, id, true);
				else
				   	  ajaxIt(dz_url, id, true);
		    }
		     });
		
		setTimeout(loadDefaultFeed, 500);
 });
</script>

</head>

<body>
<a href="#" id="refresh"><img src="images/refresh.png" title="Refresh the current feed"/></a>&nbsp;&nbsp;&nbsp;

<a href="#" id="options"><img src="images/settings.png" title="Settings"/></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://www.martani.net/" target="_blank"><img src="images/home.png" title="The author's website -martani.net-"/></a>

<img id="loadingDiv" src="images/loading.gif" alt="loading" title="loading"/>

<div id="tabs">
    <ul>
        <li><a href="#dz" ><span>&nbsp;&nbsp;Bloginy Algérie&nbsp;&nbsp;</span></a></li>
        <li><a href="#ma" ><span>&nbsp;&nbsp;Bloginy Maroc&nbsp;&nbsp;</span></a></li>
    </ul>
    <div id="dz" class="scrollable">
    </div>
    <div id="ma" class="scrollable">
    </div>
</div>
<div id="error"></div>

</body>
</html>